<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å››åˆ™è¿ç®—ç»ƒä¹ å™¨ - ä¿®æ­£ç‰ˆ</title>
     <link rel="manifest" href="./manifest.json">
    <!-- PWA æ ¸å¿ƒé…ç½® -->
    <link rel='manifest' href='data:application/manifest+json,{"name":"å››åˆ™è¿ç®—ç»ƒä¹ å™¨-ä¿®æ­£ç‰ˆ", ... }'>
    
    <!-- ä¸“é—¨ç”¨äº iOS è®¾å¤‡ä¸»å±å¹• (ç¡®ä¿ç¦»çº¿å¯ç”¨) -->
    <link rel="apple-touch-icon" href="icons/apple-icon-180.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-icon-180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/apple-icon-167.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/apple-icon-152.png">
    <meta name="apple-mobile-web-app-title" content="æ•°å­¦ç»ƒä¹ ">
    
    <!-- ç”¨äºæµè§ˆå™¨æ ‡ç­¾é¡µç­‰é€šç”¨ç¯å¢ƒ -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/manifest-icon-192.maskable.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/manifest-icon-512.maskable.png">
    
    <!-- iOS PWA å¢å¼ºå…ƒæ ‡ç­¾ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#4CAF50">
    
    <!-- ä½ çš„CSSæ ·å¼å°†åœ¨è¿™é‡Œå¼€å§‹ -->
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
            position: relative;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .tag {
            display: inline-block;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            margin-left: 10px;
            font-weight: 600;
        }
        
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .config-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .config-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .config-item label {
            font-weight: 600;
            white-space: nowrap;
        }
        
        select, input[type="number"], button {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            border: 2px solid #ddd;
            background: white;
        }
        
        input[type="number"] {
            width: 100px;
            text-align: center;
        }
        
        select:focus, input:focus, button:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        button:hover:not(:disabled) {
            background: #388E3C;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(56, 142, 60, 0.3);
        }
        
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            background: white;
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            min-width: 140px;
            text-align: center;
        }
        
        .operator-distribution {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .operator-tag {
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 13px;
        }
        
        .operator-add { background: #E8F5E9; color: #2E7D32; }
        .operator-sub { background: #F3E5F5; color: #7B1FA2; }
        .operator-mul { background: #E3F2FD; color: #1565C0; }
        .operator-div { background: #FFF3E0; color: #EF6C00; }
        
        #problemArea {
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .problem {
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #fff;
            transition: all 0.3s ease;
        }
        
        .problem:hover {
            border-color: #4CAF50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.1);
        }
        
        .expression {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
            font-family: 'Courier New', monospace;
        }
        
        .problem-type {
            display: inline-block;
            font-size: 12px;
            color: #666;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .problem input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            font-family: 'Courier New', monospace;
        }
        
        .problem input:focus {
            border-color: #4CAF50;
            outline: none;
        }
        
        .feedback {
            margin-top: 10px;
            font-weight: 600;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        
        .correct {
            border-color: #4CAF50 !important;
            background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);
        }
        
        .correct .feedback {
            color: #2e7d32;
            background: #c8e6c9;
        }
        
        .wrong {
            border-color: #f44336 !important;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }
        
        .wrong .feedback {
            color: #c62828;
            background: #ffcdd2;
        }
        
        #resultArea {
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            text-align: center;
        }
        
        #accuracy {
            font-size: 48px;
            font-weight: bold;
            color: #1565c0;
            display: block;
            margin: 10px 0;
        }
        
        .history-panel {
            margin-top: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
        }
        
        .history-panel h3 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .history-panel button {
            margin-right: 10px;
            margin-bottom: 10px;
            background: #607d8b;
        }
        
        .history-panel button:hover:not(:disabled) {
            background: #455a64;
        }
        
        .btn-smart {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2) !important;
        }
        
        .btn-smart:hover:not(:disabled) {
            background: linear-gradient(135deg, #7B1FA2, #6A1B9A) !important;
        }
        
        #historyContent {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-item, .wrong-item {
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        
        .wrong-item {
            border-left-color: #f44336;
        }
        
        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            text-align: center;
            color: #666;
            font-size: 14px;
        }
        
        #installBtn {
            margin-top: 15px;
            background: #2196F3;
        }
        
        #installBtn:hover {
            background: #1976D2;
        }
        
        .hidden {
            display: none !important;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .smart-practice-info {
            background: linear-gradient(135deg, #E1BEE7, #CE93D8);
            color: #4A148C;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
        }
        
        .knowledge-tag {
            display: inline-block;
            background: #E3F2FD;
            color: #1565C0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                border-radius: 10px;
            }
            
            .control-panel {
                flex-direction: column;
                text-align: center;
            }
            
            .config-group {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
            }
            
            .config-item {
                justify-content: space-between;
            }
            
            input[type="number"] {
                width: 80px;
            }
            
            #problemArea {
                grid-template-columns: 1fr;
                max-height: 400px;
            }
            
            .timer {
                font-size: 20px;
                min-width: 120px;
            }
            
            h1 {
                font-size: 24px;
            }
        }
        
        @media (max-width: 480px) {
            .config-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .config-item label {
                margin-bottom: 5px;
            }
            
            select, input[type="number"], button {
                width: 100%;
            }
            
            .problem input {
                font-size: 16px;
            }
            
            #problemArea {
                max-height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ§® å››åˆ™è¿ç®—ç»ƒä¹ å™¨ <span class="tag">ä¿®æ­£ç‰ˆ</span></h1>
            <p>100ä»¥å†…åŠ å‡ä¹˜é™¤å‡è¡¡ç»ƒä¹  - é¢˜ç›®æ•°é‡è‡ªå®šä¹‰ + æ™ºèƒ½é”™é¢˜æœ¬</p>
        </header>

        <div class="control-panel">
            <div class="config-group">
                <div class="config-item">
                    <label for="mode">è¿ç®—ç±»å‹ï¼š</label>
                    <select id="mode">
                        <option value="addSub">åŠ å‡æ³• (+ -)</option>
                        <option value="all">åŠ å‡ä¹˜é™¤ (+ - Ã— Ã·)</option>
                    </select>
                </div>
                
                <div class="config-item">
                    <label for="problemCount">é¢˜ç›®æ•°é‡ï¼š</label>
                    <input type="number" id="problemCount" min="1" max="1000" value="10">
                    <span style="color: #666; font-size: 14px;">(1-1000)</span>
                </div>
                
                <button id="startBtn">å¼€å§‹ç»ƒä¹ </button>
                <button id="submitBtn" disabled>æäº¤ç­”æ¡ˆ</button>
            </div>
            
            <div class="timer">
                <div>å‰©ä½™æ—¶é—´ï¼š</div>
                <div id="time">10:00</div>
            </div>
        </div>
        
        <!-- è¿ç®—ç¬¦åˆ†å¸ƒæ˜¾ç¤º -->
        <div id="operatorDistribution" class="hidden operator-distribution">
            <div class="operator-tag operator-add">åŠ æ³•: <span id="addCount">0</span></div>
            <div class="operator-tag operator-sub">å‡æ³•: <span id="subCount">0</span></div>
            <div class="operator-tag operator-mul">ä¹˜æ³•: <span id="mulCount">0</span></div>
            <div class="operator-tag operator-div">é™¤æ³•: <span id="divCount">0</span></div>
        </div>
        
        <div id="smartPracticeInfo" class="hidden smart-practice-info">
            ğŸ“š <strong>æ™ºèƒ½ç»ƒä¹ æ¨¡å¼</strong>ï¼šæ ¹æ®é”™é¢˜çŸ¥è¯†ç‚¹ç”Ÿæˆçš„ç›¸ä¼¼é¢˜ç›®ï¼Œå¸®åŠ©æ‚¨ä¸¾ä¸€åä¸‰ï¼Œå·©å›ºè–„å¼±ç¯èŠ‚ï¼
        </div>
        
        <div id="statsInfo" class="hidden stats">
            <div>æ€»é¢˜æ•°: <span id="totalProblems">0</span></div>
            <div>å·²å®Œæˆ: <span id="completedProblems">0</span></div>
            <div>æ­£ç¡®ç‡: <span id="currentAccuracy">0%</span></div>
        </div>

        <div id="problemArea" class="hidden">
            <!-- é¢˜ç›®å°†åŠ¨æ€æ’å…¥åˆ°è¿™é‡Œ -->
        </div>

        <div id="resultArea" class="hidden">
            <h3>ğŸ“Š ç»ƒä¹ ç»“æœ</h3>
            <p>æ­£ç¡®ç‡ï¼š<span id="accuracy">0%</span></p>
            <div id="detailResult"></div>
            <div id="knowledgeAnalysis" class="hidden"></div>
        </div>

        <div class="history-panel">
            <h3>ğŸ“– ç»ƒä¹ è®°å½• & æ™ºèƒ½é”™é¢˜æœ¬</h3>
            <button id="viewHistory">æŸ¥çœ‹å†å²è®°å½•</button>
            <button id="viewWrong">æŸ¥çœ‹é”™é¢˜æœ¬</button>
            <button id="smartPractice" class="btn-smart">ğŸ§  æ™ºèƒ½ä¸¾ä¸€åä¸‰ç»ƒä¹ </button>
            <button id="clearData">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
            <div id="historyContent"></div>
        </div>

        <footer>
            <p>ğŸ’¡ æç¤ºï¼šæœ¬åº”ç”¨æ”¯æŒåŠ å‡ä¹˜é™¤å‡è¡¡ç»ƒä¹ ï¼Œå¯å®‰è£…åˆ°æ¡Œé¢ç¦»çº¿ä½¿ç”¨</p>
            <button id="installBtn" class="hidden">ğŸ“² å®‰è£…åº”ç”¨åˆ°æ¡Œé¢</button>
            <p style="margin-top: 10px; font-size: 12px;">é€‚ç”¨å¹³å°ï¼šWindows 10 + Edge | iPadOS + Safari | æ‰‹æœº + Edge/Safari</p>
        </footer>
    </div>

    <script>
        // ==================== çŠ¶æ€ç®¡ç† ====================
        let state = {
            mode: 'addSub',
            problems: [],
            answers: {},
            startTime: null,
            timer: null,
            timeLeft: 600,
            isActive: false,
            totalProblems: 10,
            isSmartPractice: false,
            knowledgeTags: {},
            originalWrongProblem: null,
            operatorStats: { '+': 0, '-': 0, 'Ã—': 0, 'Ã·': 0 }
        };

        // ==================== ç®€åŒ–ç‰ˆé¢˜ç›®ç”Ÿæˆå™¨ ====================
        const ProblemGenerator = {
            /**
             * ç”Ÿæˆé¢˜ç›®ï¼ˆç®€åŒ–ç‰ˆï¼Œç¡®ä¿ä¹˜é™¤èƒ½æ­£å¸¸ç”Ÿæˆï¼‰
             */
            generateProblems(count, mode) {
                const problems = [];
                
                if (mode === 'addSub') {
                    // åŠ å‡æ³•æ¨¡å¼ï¼šåŠ å‡å„50%
                    for (let i = 0; i < count; i++) {
                        if (i % 2 === 0) {
                            problems.push(this.generateAddProblem());
                        } else {
                            problems.push(this.generateSubProblem());
                        }
                    }
                } else {
                    // åŠ å‡ä¹˜é™¤æ¨¡å¼ï¼šå››ç§è¿ç®—å„25%
                    const operators = ['+', '-', 'Ã—', 'Ã·'];
                    const baseCount = Math.floor(count / 4);
                    
                    // ç”ŸæˆåŸºæœ¬é¢˜ç›®
                    for (let i = 0; i < baseCount; i++) {
                        problems.push(this.generateAddProblem());
                        problems.push(this.generateSubProblem());
                        problems.push(this.generateMulProblem());
                        problems.push(this.generateDivProblem());
                    }
                    
                    // è¡¥å……å‰©ä½™é¢˜ç›®
                    const remainder = count % 4;
                    for (let i = 0; i < remainder; i++) {
                        const randomOp = operators[Math.floor(Math.random() * operators.length)];
                        if (randomOp === '+') problems.push(this.generateAddProblem());
                        else if (randomOp === '-') problems.push(this.generateSubProblem());
                        else if (randomOp === 'Ã—') problems.push(this.generateMulProblem());
                        else if (randomOp === 'Ã·') problems.push(this.generateDivProblem());
                    }
                }
                
                // éšæœºæ‰“ä¹±é¡ºåº
                this.shuffleArray(problems);
                
                // ä¸ºæ¯é“é¢˜åˆ†é…å”¯ä¸€IDå’Œé»˜è®¤å±æ€§
                return problems.map((p, index) => ({
                    ...p,
                    id: index,
                    userAnswer: null,
                    isCorrect: false,
                    timestamp: Date.now()
                }));
            },
            
            /**
             * ç”ŸæˆåŠ æ³•é¢˜
             */
            generateAddProblem() {
                // ç¡®ä¿ç»“æœåœ¨0-100ä¹‹é—´
                const result = Math.floor(Math.random() * 101);
                const a = Math.floor(Math.random() * (result + 1));
                const b = result - a;
                const unknownPos = Math.floor(Math.random() * 3);
                
                return {
                    a, b,
                    op: '+',
                    result,
                    unknownPos
                };
            },
            
            /**
             * ç”Ÿæˆå‡æ³•é¢˜
             */
            generateSubProblem() {
                // ç¡®ä¿ç»“æœåœ¨0-100ä¹‹é—´
                const result = Math.floor(Math.random() * 101);
                const b = Math.floor(Math.random() * 101);
                let a = result + b;
                
                // å¦‚æœaè¶…è¿‡100ï¼Œè°ƒæ•´b
                if (a > 100) {
                    a = 100;
                    b = a - result;
                }
                
                const unknownPos = Math.floor(Math.random() * 3);
                
                return {
                    a, b,
                    op: '-',
                    result,
                    unknownPos
                };
            },
            
            /**
             * ç”Ÿæˆä¹˜æ³•é¢˜ï¼ˆç¡®ä¿ç»“æœåœ¨0-100ä¹‹é—´ï¼‰
             */
            generateMulProblem() {
                // é™åˆ¶å› æ•°å¤§å°ï¼Œç¡®ä¿ç»“æœä¸è¶…è¿‡100
                let a, b, result;
                
                // ç”Ÿæˆå°æ•°å­—ä¹˜æ³•ï¼ˆæ›´å¸¸è§ï¼‰
                if (Math.random() < 0.7) {
                    // 2-9çš„ä¹˜æ³•
                    a = Math.floor(Math.random() * 8) + 2; // 2-9
                    b = Math.floor(Math.random() * Math.floor(100 / a)) + 1; // ç¡®ä¿ç»“æœâ‰¤100
                } else {
                    // åŒ…å«1æˆ–10çš„ä¹˜æ³•
                    a = Math.random() < 0.5 ? 1 : Math.floor(Math.random() * 10) + 1;
                    b = Math.floor(Math.random() * Math.floor(100 / a)) + 1;
                }
                
                result = a * b;
                const unknownPos = Math.floor(Math.random() * 3);
                
                return {
                    a, b,
                    op: 'Ã—',
                    result,
                    unknownPos
                };
            },
            
            /**
             * ç”Ÿæˆé™¤æ³•é¢˜ï¼ˆç¡®ä¿æ•´é™¤ï¼‰
             */
            generateDivProblem() {
                // å…ˆç”Ÿæˆä¸€ä¸ªç»“æœå’Œé™¤æ•°ï¼Œå†è®¡ç®—è¢«é™¤æ•°
                let result, b, a;
                
                // ç”Ÿæˆå°æ•°å­—é™¤æ³•ï¼ˆæ›´å¸¸è§ï¼‰
                if (Math.random() < 0.7) {
                    result = Math.floor(Math.random() * 10) + 1; // 1-10
                    b = Math.floor(Math.random() * 10) + 1; // 1-10
                } else {
                    result = Math.floor(Math.random() * 20) + 1; // 1-20
                    b = Math.floor(Math.random() * 10) + 1; // 1-10
                }
                
                a = result * b;
                
                // ç¡®ä¿è¢«é™¤æ•°ä¸è¶…è¿‡100
                while (a > 100) {
                    b = Math.floor(Math.random() * 10) + 1;
                    a = result * b;
                }
                
                const unknownPos = Math.floor(Math.random() * 3);
                
                return {
                    a, b,
                    op: 'Ã·',
                    result,
                    unknownPos
                };
            },
            
            /**
             * éšæœºæ‰“ä¹±æ•°ç»„
             */
            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },
            
            /**
             * ç”Ÿæˆç›¸ä¼¼é¢˜ç›®ï¼ˆç”¨äºæ™ºèƒ½ç»ƒä¹ ï¼‰
             */
            generateSimilarProblem(originalProblem) {
                // 70%çš„æ¦‚ç‡ä¿æŒç›¸åŒè¿ç®—ç¬¦
                const keepSameOp = Math.random() < 0.7;
                let newOp = originalProblem.op;
                
                if (!keepSameOp) {
                    // éšæœºé€‰æ‹©å…¶ä»–è¿ç®—ç¬¦
                    const allOps = ['+', '-', 'Ã—', 'Ã·'];
                    const otherOps = allOps.filter(op => op !== originalProblem.op);
                    newOp = otherOps[Math.floor(Math.random() * otherOps.length)];
                }
                
                // æ ¹æ®è¿ç®—ç¬¦ç”Ÿæˆæ–°é¢˜ç›®
                let newProblem;
                if (newOp === '+') newProblem = this.generateAddProblem();
                else if (newOp === '-') newProblem = this.generateSubProblem();
                else if (newOp === 'Ã—') newProblem = this.generateMulProblem();
                else if (newOp === 'Ã·') newProblem = this.generateDivProblem();
                
                // ä¿æŒç›¸åŒçš„æœªçŸ¥æ•°ä½ç½®
                newProblem.unknownPos = originalProblem.unknownPos;
                
                return newProblem;
            }
        };

        // ==================== çŸ¥è¯†ç‚¹åˆ†æå™¨ ====================
        const KnowledgeAnalyzer = {
            analyzeProblem(problem) {
                const tags = [];
                if (problem.op === '+') tags.push('åŠ æ³•');
                else if (problem.op === '-') tags.push('å‡æ³•');
                else if (problem.op === 'Ã—') tags.push('ä¹˜æ³•');
                else if (problem.op === 'Ã·') tags.push('é™¤æ³•');
                
                if (problem.unknownPos === 0) tags.push('æ±‚ç»“æœ');
                else if (problem.unknownPos === 1) tags.push('æ±‚å‰æ•°');
                else tags.push('æ±‚åæ•°');
                
                return tags;
            },
            
            generateSimilarProblems(originalProblem, count = 3) {
                const similarProblems = [];
                for (let i = 0; i < count; i++) {
                    const similar = ProblemGenerator.generateSimilarProblem(originalProblem);
                    similarProblems.push(similar);
                }
                return similarProblems;
            }
        };

        // ==================== DOMå…ƒç´ å¼•ç”¨ ====================
        const elements = {
            startBtn: document.getElementById('startBtn'),
            submitBtn: document.getElementById('submitBtn'),
            problemArea: document.getElementById('problemArea'),
            resultArea: document.getElementById('resultArea'),
            timeDisplay: document.getElementById('time'),
            modeSelect: document.getElementById('mode'),
            problemCountInput: document.getElementById('problemCount'),
            accuracyDisplay: document.getElementById('accuracy'),
            detailResult: document.getElementById('detailResult'),
            knowledgeAnalysis: document.getElementById('knowledgeAnalysis'),
            historyContent: document.getElementById('historyContent'),
            viewHistoryBtn: document.getElementById('viewHistory'),
            viewWrongBtn: document.getElementById('viewWrong'),
            smartPracticeBtn: document.getElementById('smartPractice'),
            clearDataBtn: document.getElementById('clearData'),
            installBtn: document.getElementById('installBtn'),
            statsInfo: document.getElementById('statsInfo'),
            smartPracticeInfo: document.getElementById('smartPracticeInfo'),
            operatorDistribution: document.getElementById('operatorDistribution'),
            addCount: document.getElementById('addCount'),
            subCount: document.getElementById('subCount'),
            mulCount: document.getElementById('mulCount'),
            divCount: document.getElementById('divCount'),
            totalProblemsSpan: document.getElementById('totalProblems'),
            completedProblemsSpan: document.getElementById('completedProblems'),
            currentAccuracySpan: document.getElementById('currentAccuracy')
        };

        // ==================== äº‹ä»¶ç›‘å¬å™¨ ====================
        document.addEventListener('DOMContentLoaded', initApp);
        elements.startBtn.addEventListener('click', startPractice);
        elements.submitBtn.addEventListener('click', submitAnswers);
        elements.viewHistoryBtn.addEventListener('click', () => showHistory());
        elements.viewWrongBtn.addEventListener('click', () => showWrongProblems());
        elements.smartPracticeBtn.addEventListener('click', startSmartPractice);
        elements.clearDataBtn.addEventListener('click', clearAllData);
        elements.problemCountInput.addEventListener('change', validateProblemCount);
        elements.problemCountInput.addEventListener('input', validateProblemCount);

        // ==================== åˆå§‹åŒ–åº”ç”¨ ====================
        function initApp() {
            console.log('å››åˆ™è¿ç®—ç»ƒä¹ å™¨å·²åˆå§‹åŒ–');
            initPWA();
            const savedCount = localStorage.getItem('problemCount');
            if (savedCount) {
                elements.problemCountInput.value = savedCount;
            }
            
            // æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
            console.log('ç‰ˆæœ¬: ä¿®æ­£ç‰ˆ - ä¿®å¤äº†ä¹˜é™¤é¢˜ç›®ç”Ÿæˆé—®é¢˜');
        }

        // ==================== éªŒè¯é¢˜ç›®æ•°é‡ ====================
        function validateProblemCount() {
            let count = parseInt(elements.problemCountInput.value);
            
            if (isNaN(count) || count < 1) {
                elements.problemCountInput.value = 1;
                count = 1;
            }
            
            if (count > 1000) {
                elements.problemCountInput.value = 1000;
                count = 1000;
            }
            
            localStorage.setItem('problemCount', count.toString());
            return count;
        }

        // ==================== 1. å¼€å§‹ç»ƒä¹  ====================
        function startPractice() {
            if (state.isActive) {
                if (!confirm('ç»ƒä¹ æ­£åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿ')) return;
                clearInterval(state.timer);
            }

            const problemCount = validateProblemCount();
            state.totalProblems = problemCount;
            state.isSmartPractice = false;
            
            resetState();
            
            // ä½¿ç”¨æ–°çš„ç”Ÿæˆå™¨ç”Ÿæˆé¢˜ç›®
            state.problems = ProblemGenerator.generateProblems(
                state.totalProblems, 
                elements.modeSelect.value
            );
            
            // ç»Ÿè®¡è¿ç®—ç¬¦åˆ†å¸ƒ
            updateOperatorStats();
            
            setupPracticeUI('ç»ƒä¹ ');
        }

        // ==================== 2. å¼€å§‹æ™ºèƒ½ä¸¾ä¸€åä¸‰ç»ƒä¹  ====================
        function startSmartPractice() {
            try {
                const wrongList = JSON.parse(localStorage.getItem('mathWrongProblems')) || [];
                
                if (wrongList.length === 0) {
                    showNotification('æš‚æ— é”™é¢˜è®°å½•ï¼Œè¯·å…ˆå®Œæˆç»ƒä¹ å¹¶äº§ç”Ÿé”™é¢˜', 'error');
                    return;
                }
                
                // é€‰æ‹©æœ€è¿‘çš„ä¸€é“é”™é¢˜ä½œä¸ºåŸºç¡€
                const latestWrongProblem = wrongList[wrongList.length - 1];
                state.originalWrongProblem = latestWrongProblem;
                
                // åˆ†æé”™é¢˜çŸ¥è¯†ç‚¹
                const knowledgeTags = KnowledgeAnalyzer.analyzeProblem(latestWrongProblem);
                
                // ç”Ÿæˆç›¸ä¼¼é¢˜ç›®ï¼ˆåŸé¢˜ + 3é“ç›¸ä¼¼é¢˜ï¼‰
                const similarProblems = KnowledgeAnalyzer.generateSimilarProblems(latestWrongProblem, 3);
                
                // æ„å»ºç»ƒä¹ é¢˜ç›®ï¼šåŸé”™é¢˜ + ç›¸ä¼¼é¢˜
                state.problems = [
                    { ...latestWrongProblem, id: 0, isOriginalWrong: true },
                    ...similarProblems.map((p, idx) => ({ ...p, id: idx + 1 }))
                ];
                
                state.totalProblems = state.problems.length;
                state.isSmartPractice = true;
                
                resetState();
                
                // ç»Ÿè®¡è¿ç®—ç¬¦åˆ†å¸ƒ
                updateOperatorStats();
                
                // è®¾ç½®æ™ºèƒ½ç»ƒä¹ UI
                setupPracticeUI('æ™ºèƒ½ç»ƒä¹ ');
                
                // æ˜¾ç¤ºçŸ¥è¯†ç‚¹åˆ†æ
                elements.smartPracticeInfo.classList.remove('hidden');
                elements.smartPracticeInfo.innerHTML = `
                    ğŸ“š <strong>æ™ºèƒ½ç»ƒä¹ æ¨¡å¼</strong><br>
                    åŸºäºé”™é¢˜ï¼š${formatProblemExpression(latestWrongProblem)}<br>
                    çŸ¥è¯†ç‚¹ï¼š${knowledgeTags.map(tag => `<span class="knowledge-tag">${tag}</span>`).join(' ')}
                `;
                
                showNotification(`å¼€å§‹æ™ºèƒ½ç»ƒä¹ ï¼š${knowledgeTags.join('ã€')}`, 'info');
                
            } catch (e) {
                console.error('æ™ºèƒ½ç»ƒä¹ å¤±è´¥:', e);
                showNotification('æ™ºèƒ½ç»ƒä¹ åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }

        // ==================== æ›´æ–°è¿ç®—ç¬¦ç»Ÿè®¡ ====================
        function updateOperatorStats() {
            // é‡ç½®ç»Ÿè®¡
            state.operatorStats = { '+': 0, '-': 0, 'Ã—': 0, 'Ã·': 0 };
            
            // ç»Ÿè®¡æ¯ç§è¿ç®—ç¬¦çš„æ•°é‡
            state.problems.forEach(problem => {
                const op = problem.op;
                if (state.operatorStats.hasOwnProperty(op)) {
                    state.operatorStats[op]++;
                }
            });
            
            // æ›´æ–°æ˜¾ç¤º
            elements.addCount.textContent = state.operatorStats['+'];
            elements.subCount.textContent = state.operatorStats['-'];
            elements.mulCount.textContent = state.operatorStats['Ã—'];
            elements.divCount.textContent = state.operatorStats['Ã·'];
            
            // æ˜¾ç¤ºç»Ÿè®¡é¢æ¿
            elements.operatorDistribution.classList.remove('hidden');
        }

        // ==================== è¾…åŠ©å‡½æ•°ï¼šè®¾ç½®ç»ƒä¹ UI ====================
        function setupPracticeUI(modeName) {
            // æ˜¾ç¤ºé¢˜ç›®åŒºåŸŸå’Œç»Ÿè®¡ä¿¡æ¯
            elements.problemArea.classList.remove('hidden');
            elements.statsInfo.classList.remove('hidden');
            elements.resultArea.classList.add('hidden');
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats();
            
            // æ¸²æŸ“é¢˜ç›®
            renderProblems();
            
            // å¯ç”¨æäº¤æŒ‰é’®ï¼Œç¦ç”¨å¼€å§‹æŒ‰é’®
            elements.submitBtn.disabled = false;
            elements.startBtn.disabled = true;
            elements.smartPracticeBtn.disabled = true;
            
            // å¼€å§‹å€’è®¡æ—¶
            startTimer();
            
            // è‡ªåŠ¨èšç„¦åˆ°ç¬¬ä¸€é¢˜
            const firstInput = document.querySelector('.problem input');
            if (firstInput) firstInput.focus();
            
            // æ˜¾ç¤ºè¿ç®—ç¬¦åˆ†å¸ƒ
            const modeText = state.mode === 'addSub' ? 'åŠ å‡æ³•' : 'åŠ å‡ä¹˜é™¤';
            const distributionText = state.mode === 'all' ? 
                `(åˆ†å¸ƒ: åŠ ${state.operatorStats['+']} å‡${state.operatorStats['-']} ä¹˜${state.operatorStats['Ã—']} é™¤${state.operatorStats['Ã·']})` : 
                `(åˆ†å¸ƒ: åŠ ${state.operatorStats['+']} å‡${state.operatorStats['-']})`;
            
            showNotification(`å¼€å§‹${modeName}ï¼š${state.totalProblems}é¢˜${modeText} ${distributionText}ï¼Œæ—¶é—´10åˆ†é’Ÿ`, 'info');
        }

        // ==================== 3. æ¸²æŸ“é¢˜ç›® ====================
        function renderProblems() {
            elements.problemArea.innerHTML = '';
            
            if (state.totalProblems > 20) {
                elements.problemArea.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
            } else {
                elements.problemArea.style.gridTemplateColumns = 'repeat(auto-fill, minmax(350px, 1fr))';
            }
            
            state.problems.forEach((p, index) => {
                const div = document.createElement('div');
                div.className = 'problem';
                div.id = `problem-${p.id}`;
                
                // æ ¼å¼åŒ–é¢˜ç›®è¡¨è¾¾å¼
                const expression = formatProblemExpression(p);
                
                // æ·»åŠ é¢˜ç›®ç±»å‹æ ‡ç­¾ï¼ˆæ™ºèƒ½ç»ƒä¹ æ¨¡å¼ä¸‹ï¼‰
                let typeLabel = '';
                if (state.isSmartPractice) {
                    if (p.isOriginalWrong) {
                        typeLabel = '<span class="problem-type" style="background:#FFCDD2;color:#C62828;">åŸé”™é¢˜</span>';
                    } else if (p.isSimilar) {
                        typeLabel = '<span class="problem-type" style="background:#E1BEE7;color:#7B1FA2;">ç›¸ä¼¼é¢˜</span>';
                    }
                }
                
                // æ·»åŠ è¿ç®—ç¬¦æ ‡ç­¾
                let operatorLabel = '';
                if (p.op === '+') {
                    operatorLabel = '<span class="problem-type" style="background:#E8F5E9;color:#2E7D32;">åŠ æ³•</span>';
                } else if (p.op === '-') {
                    operatorLabel = '<span class="problem-type" style="background:#F3E5F5;color:#7B1FA2;">å‡æ³•</span>';
                } else if (p.op === 'Ã—') {
                    operatorLabel = '<span class="problem-type" style="background:#E3F2FD;color:#1565C0;">ä¹˜æ³•</span>';
                } else if (p.op === 'Ã·') {
                    operatorLabel = '<span class="problem-type" style="background:#FFF3E0;color:#EF6C00;">é™¤æ³•</span>';
                }
                
                div.innerHTML = `
                    <div class="expression">
                        ${index + 1}. ${expression} 
                        ${operatorLabel}
                        ${typeLabel}
                    </div>
                    <input type="number" 
                           min="0" 
                           max="100" 
                           step="1"
                           data-id="${p.id}" 
                           placeholder="è¾“å…¥ç­”æ¡ˆ (0-100)"
                           oninput="saveAnswer(${p.id}, this.value)"
                           onkeypress="handleEnterKey(event, ${p.id})">
                `;
                
                elements.problemArea.appendChild(div);
            });
            
            // æ¢å¤å·²ä¿å­˜çš„ç­”æ¡ˆ
            state.problems.forEach(p => {
                if (state.answers[p.id] !== undefined) {
                    const input = document.querySelector(`input[data-id="${p.id}"]`);
                    if (input) input.value = state.answers[p.id];
                }
            });
            
            updateStats();
        }

        // ==================== è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–é¢˜ç›®è¡¨è¾¾å¼ ====================
        function formatProblemExpression(p) {
            if (p.unknownPos === 0) {
                return `${p.a} ${p.op} ${p.b} = ?`;
            } else if (p.unknownPos === 1) {
                return `? ${p.op} ${p.b} = ${p.result}`;
            } else {
                return `${p.a} ${p.op} ? = ${p.result}`;
            }
        }

        // ==================== 4. æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ ====================
        function updateStats() {
            elements.totalProblemsSpan.textContent = state.totalProblems;
            
            const answeredCount = Object.keys(state.answers).length;
            elements.completedProblemsSpan.textContent = `${answeredCount}/${state.totalProblems}`;
            
            let correctCount = 0;
            let answeredTotal = 0;
            
            state.problems.forEach(p => {
                if (state.answers[p.id] !== undefined && state.answers[p.id] !== null) {
                    answeredTotal++;
                    
                    let correctAnswer;
                    if (p.unknownPos === 0) {
                        correctAnswer = p.result;
                    } else if (p.unknownPos === 1) {
                        correctAnswer = p.a;
                    } else {
                        correctAnswer = p.b;
                    }
                    
                    if (state.answers[p.id] === correctAnswer) {
                        correctCount++;
                    }
                }
            });
            
            const accuracy = answeredTotal > 0 ? (correctCount / answeredTotal * 100).toFixed(1) : 0;
            elements.currentAccuracySpan.textContent = `${accuracy}%`;
        }

        // ==================== 5. ä¿å­˜ç­”æ¡ˆ ====================
        function saveAnswer(id, value) {
            const numValue = parseInt(value);
            if (!isNaN(numValue)) {
                state.answers[id] = numValue;
            } else {
                state.answers[id] = null;
            }
            
            localStorage.setItem('tempAnswers', JSON.stringify(state.answers));
            updateStats();
        }

        // ==================== 6. å¤„ç†å›è½¦é”® ====================
        function handleEnterKey(event, id) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const inputs = document.querySelectorAll('.problem input');
                const currentIndex = Array.from(inputs).findIndex(input => input.dataset.id == id);
                
                if (currentIndex < inputs.length - 1) {
                    inputs[currentIndex + 1].focus();
                } else {
                    elements.submitBtn.focus();
                }
            }
        }

        // ==================== 7. å€’è®¡æ—¶ ====================
        function startTimer() {
            clearInterval(state.timer);
            
            state.timer = setInterval(() => {
                state.timeLeft--;
                
                const min = Math.floor(state.timeLeft / 60);
                const sec = state.timeLeft % 60;
                elements.timeDisplay.textContent = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
                
                if (state.timeLeft <= 0) {
                    clearInterval(state.timer);
                    elements.timeDisplay.textContent = '00:00';
                    submitAnswers();
                }
                
                if (state.timeLeft <= 60) {
                    elements.timeDisplay.style.color = '#f44336';
                }
                
                if (state.timeLeft % 60 === 0) {
                    saveTempProgress();
                }
            }, 1000);
        }

        // ==================== 8. æäº¤ç­”æ¡ˆ ====================
        function submitAnswers() {
            if (!state.isActive) return;
            
            state.isActive = false;
            clearInterval(state.timer);
            
            let correctCount = 0;
            const resultDetails = [];
            
            state.problems.forEach(p => {
                p.userAnswer = state.answers[p.id] !== undefined ? state.answers[p.id] : null;
                
                let correctAnswer;
                if (p.unknownPos === 0) {
                    correctAnswer = p.result;
                } else if (p.unknownPos === 1) {
                    correctAnswer = p.a;
                } else {
                    correctAnswer = p.b;
                }
                
                p.isCorrect = p.userAnswer === correctAnswer;
                if (p.isCorrect) correctCount++;
                
                const problemDiv = document.getElementById(`problem-${p.id}`);
                if (problemDiv) {
                    problemDiv.classList.add(p.isCorrect ? 'correct' : 'wrong');
                    
                    const feedback = document.createElement('div');
                    feedback.className = 'feedback';
                    feedback.innerHTML = p.isCorrect ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯';
                    problemDiv.appendChild(feedback);
                    
                    const input = problemDiv.querySelector('input');
                    if (input) input.disabled = true;
                }
                
                resultDetails.push({
                    problem: p,
                    isCorrect: p.isCorrect
                });
            });
            
            const accuracy = (correctCount / state.problems.length * 100).toFixed(1);
            elements.accuracyDisplay.textContent = `${accuracy}%`;
            
            const timeUsed = 600 - state.timeLeft;
            const timeUsedMin = Math.floor(timeUsed / 60);
            const timeUsedSec = timeUsed % 60;
            
            // è®¡ç®—å„è¿ç®—ç¬¦çš„æ­£ç¡®ç‡
            let operatorAccuracy = {};
            Object.keys(state.operatorStats).forEach(op => {
                const opProblems = state.problems.filter(p => p.op === op);
                const opCorrect = opProblems.filter(p => p.isCorrect).length;
                operatorAccuracy[op] = opProblems.length > 0 ? 
                    (opCorrect / opProblems.length * 100).toFixed(1) : '0.0';
            });
            
            elements.detailResult.innerHTML = `
                <p>å®Œæˆé¢˜ç›®: ${correctCount}/${state.totalProblems}</p>
                <p>ç”¨æ—¶: ${timeUsedMin}åˆ†${timeUsedSec}ç§’</p>
                <p>å¹³å‡æ¯é¢˜ç”¨æ—¶: ${(timeUsed / state.totalProblems).toFixed(1)}ç§’</p>
                ${state.mode === 'all' ? `
                    <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px;">
                        <p style="margin: 5px 0; font-weight: bold;">å„è¿ç®—æ­£ç¡®ç‡:</p>
                        <p style="margin: 5px 0;">åŠ æ³•: ${operatorAccuracy['+']}% (${state.problems.filter(p => p.op === '+').filter(p => p.isCorrect).length}/${state.operatorStats['+']})</p>
                        <p style="margin: 5px 0;">å‡æ³•: ${operatorAccuracy['-']}% (${state.problems.filter(p => p.op === '-').filter(p => p.isCorrect).length}/${state.operatorStats['-']})</p>
                        <p style="margin: 5px 0;">ä¹˜æ³•: ${operatorAccuracy['Ã—']}% (${state.problems.filter(p => p.op === 'Ã—').filter(p => p.isCorrect).length}/${state.operatorStats['Ã—']})</p>
                        <p style="margin: 5px 0;">é™¤æ³•: ${operatorAccuracy['Ã·']}% (${state.problems.filter(p => p.op === 'Ã·').filter(p => p.isCorrect).length}/${state.operatorStats['Ã·']})</p>
                    </div>
                ` : ''}
            `;
            
            elements.resultArea.classList.remove('hidden');
            elements.statsInfo.classList.add('hidden');
            elements.smartPracticeInfo.classList.add('hidden');
            elements.operatorDistribution.classList.add('hidden');
            
            elements.startBtn.disabled = false;
            elements.submitBtn.disabled = true;
            elements.smartPracticeBtn.disabled = false;
            
            if (!state.isSmartPractice) {
                saveHistory(accuracy, correctCount, timeUsed);
                saveWrongProblems();
            }
            
            localStorage.removeItem('tempAnswers');
            localStorage.removeItem('tempProgress');
            
            showNotification(`ç»ƒä¹ å®Œæˆï¼æ­£ç¡®ç‡: ${accuracy}%`, 'success');
        }

        // ==================== 9. ä¿å­˜å†å²è®°å½• ====================
        function saveHistory(accuracy, correctCount, timeUsed) {
            try {
                const history = JSON.parse(localStorage.getItem('mathPracticeHistory')) || [];
                
                history.unshift({
                    date: new Date().toLocaleString('zh-CN'),
                    mode: state.mode === 'addSub' ? 'åŠ å‡æ³•' : 'åŠ å‡ä¹˜é™¤',
                    total: state.totalProblems,
                    correct: correctCount,
                    accuracy: parseFloat(accuracy),
                    timeUsed: timeUsed,
                    timestamp: Date.now(),
                    isSmartPractice: state.isSmartPractice
                });
                
                if (history.length > 100) history.length = 100;
                
                localStorage.setItem('mathPracticeHistory', JSON.stringify(history));
            } catch (e) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
            }
        }

        // ==================== 10. ä¿å­˜é”™é¢˜ ====================
        function saveWrongProblems() {
            try {
                const wrongProblems = state.problems.filter(p => !p.isCorrect);
                if (wrongProblems.length === 0) return;
                
                const wrongList = JSON.parse(localStorage.getItem('mathWrongProblems')) || [];
                
                wrongProblems.forEach(p => {
                    // æ·»åŠ çŸ¥è¯†ç‚¹åˆ†æ
                    const tags = KnowledgeAnalyzer.analyzeProblem(p);
                    
                    const isDuplicate = wrongList.some(wp => 
                        wp.a === p.a && wp.b === p.b && wp.op === p.op && 
                        wp.unknownPos === p.unknownPos && wp.result === p.result
                    );
                    
                    if (!isDuplicate) {
                        wrongList.push({
                            ...p,
                            date: new Date().toLocaleString('zh-CN'),
                            practiceDate: new Date().toLocaleDateString('zh-CN'),
                            knowledgeTags: tags,
                            wrongCount: 1
                        });
                    }
                });
                
                if (wrongList.length > 200) {
                    wrongList.length = 200;
                }
                
                localStorage.setItem('mathWrongProblems', JSON.stringify(wrongList));
                console.log(`ä¿å­˜äº†${wrongProblems.length}é“é”™é¢˜ï¼ŒåŒ…å«ä¹˜é™¤é¢˜ç›®`);
            } catch (e) {
                console.error('ä¿å­˜é”™é¢˜å¤±è´¥:', e);
            }
        }

        // ==================== 11. æ˜¾ç¤ºå†å²è®°å½• ====================
        function showHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('mathPracticeHistory')) || [];
                
                if (history.length === 0) {
                    elements.historyContent.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— ç»ƒä¹ è®°å½•</p>';
                    return;
                }
                
                let html = '<div class="history-list">';
                history.forEach((record, idx) => {
                    const timeUsedMin = Math.floor(record.timeUsed / 60);
                    const timeUsedSec = record.timeUsed % 60;
                    const practiceType = record.isSmartPractice ? '<span style="color:#9C27B0;">[æ™ºèƒ½]</span>' : '';
                    
                    html += `
                        <div class="history-item">
                            <div><strong>${record.date}</strong> ${practiceType}</div>
                            <div>ç±»å‹: ${record.mode} | é¢˜é‡: ${record.total}é¢˜</div>
                            <div>æ­£ç¡®ç‡: <span style="color: ${record.accuracy >= 90 ? '#4CAF50' : record.accuracy >= 70 ? '#FF9800' : '#f44336'}; font-weight: bold;">${record.accuracy}%</span></div>
                            <div>ç”¨æ—¶: ${timeUsedMin}åˆ†${timeUsedSec}ç§’ | æ­£ç¡®: ${record.correct}/${record.total}</div>
                        </div>
                    `;
                });
                html += '</div>';
                
                elements.historyContent.innerHTML = html;
            } catch (e) {
                elements.historyContent.innerHTML = '<p style="color: #f44336;">åŠ è½½å†å²è®°å½•å¤±è´¥</p>';
            }
        }

        // ==================== 12. æ˜¾ç¤ºé”™é¢˜æœ¬ ====================
        function showWrongProblems() {
            try {
                const wrongList = JSON.parse(localStorage.getItem('mathWrongProblems')) || [];
                
                if (wrongList.length === 0) {
                    elements.historyContent.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— é”™é¢˜è®°å½•</p>';
                    return;
                }
                
                // ç»Ÿè®¡å„è¿ç®—ç¬¦é”™é¢˜æ•°é‡
                const opStats = { '+': 0, '-': 0, 'Ã—': 0, 'Ã·': 0 };
                wrongList.forEach(p => {
                    if (opStats.hasOwnProperty(p.op)) {
                        opStats[p.op]++;
                    }
                });
                
                let html = '<div class="wrong-list">';
                
                // æ˜¾ç¤ºé”™é¢˜ç»Ÿè®¡
                html += `
                    <div style="background: #FFF3E0; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="margin-top: 0; color: #EF6C00;">ğŸ“Š é”™é¢˜ç»Ÿè®¡</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            <div>åŠ æ³•: ${opStats['+']}é¢˜</div>
                            <div>å‡æ³•: ${opStats['-']}é¢˜</div>
                            <div>ä¹˜æ³•: ${opStats['Ã—']}é¢˜</div>
                            <div>é™¤æ³•: ${opStats['Ã·']}é¢˜</div>
                        </div>
                    </div>
                `;
                
                // æ˜¾ç¤ºæ‰€æœ‰é”™é¢˜
                wrongList.forEach((problem, idx) => {
                    const expression = formatProblemExpression(problem);
                    const wrongCount = problem.wrongCount || 1;
                    
                    html += `
                        <div class="wrong-item">
                            <div style="font-size: 18px; margin-bottom: 8px;">
                                <strong>${expression}</strong>
                                <span style="font-size: 12px; color: #999; margin-left: 10px;">é”™è¯¯${wrongCount}æ¬¡</span>
                            </div>
                            <div>ä½ çš„ç­”æ¡ˆ: ${problem.userAnswer !== null ? problem.userAnswer : 'æœªä½œç­”'}</div>
                            <div style="margin: 8px 0;">
                                ${problem.knowledgeTags ? problem.knowledgeTags.map(t => `<span class="knowledge-tag">${t}</span>`).join(' ') : ''}
                            </div>
                            <div style="font-size: 12px; color: #999;">${problem.date}</div>
                            <div style="margin-top: 10px;">
                                <button onclick="redoWrongProblem(${problem.id || idx})" style="margin-right: 10px; padding: 8px 15px; font-size: 14px;">é‡åšæ­¤é¢˜</button>
                                <button onclick="smartPracticeFromProblem(${problem.id || idx})" style="background:#9C27B0; padding: 8px 15px; font-size: 14px;">æ™ºèƒ½ç»ƒä¹ </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                elements.historyContent.innerHTML = html;
            } catch (e) {
                elements.historyContent.innerHTML = '<p style="color: #f44336;">åŠ è½½é”™é¢˜æœ¬å¤±è´¥</p>';
            }
        }

        // ==================== 13. ä»ç‰¹å®šé”™é¢˜å¼€å§‹æ™ºèƒ½ç»ƒä¹  ====================
        function smartPracticeFromProblem(index) {
            try {
                const wrongList = JSON.parse(localStorage.getItem('mathWrongProblems')) || [];
                const problem = wrongList.find(p => p.id === index) || wrongList[index];
                
                if (!problem) {
                    showNotification('æœªæ‰¾åˆ°è¯¥é”™é¢˜', 'error');
                    return;
                }
                
                state.originalWrongProblem = problem;
                const knowledgeTags = KnowledgeAnalyzer.analyzeProblem(problem);
                const similarProblems = KnowledgeAnalyzer.generateSimilarProblems(problem, 3);
                
                state.problems = [
                    { ...problem, id: 0, isOriginalWrong: true },
                    ...similarProblems.map((p, idx) => ({ ...p, id: idx + 1 }))
                ];
                
                state.totalProblems = state.problems.length;
                state.isSmartPractice = true;
                
                resetState();
                
                // ç»Ÿè®¡è¿ç®—ç¬¦åˆ†å¸ƒ
                updateOperatorStats();
                
                setupPracticeUI('æ™ºèƒ½ç»ƒä¹ ');
                
                elements.smartPracticeInfo.classList.remove('hidden');
                elements.smartPracticeInfo.innerHTML = `
                    ğŸ“š <strong>æ™ºèƒ½ç»ƒä¹ æ¨¡å¼</strong><br>
                    åŸºäºé”™é¢˜ï¼š${formatProblemExpression(problem)}<br>
                    çŸ¥è¯†ç‚¹ï¼š${knowledgeTags.map(tag => `<span class="knowledge-tag">${tag}</span>`).join(' ')}
                `;
                
                showNotification(`å¼€å§‹${knowledgeTags.join('ã€')}ä¸“é¡¹ç»ƒä¹ `, 'info');
            } catch (e) {
                console.error('æ™ºèƒ½ç»ƒä¹ å¤±è´¥:', e);
                showNotification('æ™ºèƒ½ç»ƒä¹ åˆå§‹åŒ–å¤±è´¥', 'error');
            }
        }

        // ==================== 14. é‡åšé”™é¢˜ ====================
        function redoWrongProblem(index) {
            try {
                const wrongList = JSON.parse(localStorage.getItem('mathWrongProblems')) || [];
                const problem = wrongList.find(p => p.id === index) || wrongList[index];
                
                if (!problem) {
                    showNotification('æœªæ‰¾åˆ°è¯¥é”™é¢˜', 'error');
                    return;
                }
                
                // å¼€å§‹å•é¢˜ç»ƒä¹ 
                state.problems = [{...problem, id: 0}];
                state.totalProblems = 1;
                state.isSmartPractice = false;
                
                resetState();
                
                elements.problemArea.classList.remove('hidden');
                elements.statsInfo.classList.remove('hidden');
                elements.resultArea.classList.add('hidden');
                elements.smartPracticeInfo.classList.add('hidden');
                
                updateStats();
                renderProblems();
                
                elements.submitBtn.disabled = false;
                elements.startBtn.disabled = true;
                elements.smartPracticeBtn.disabled = true;
                
                startTimer();
                
                const input = document.querySelector('.problem input');
                if (input) input.focus();
                
                showNotification('å¼€å§‹é‡åšé”™é¢˜', 'info');
            } catch (e) {
                console.error('é‡åšé”™é¢˜å¤±è´¥:', e);
                showNotification('é‡åšé”™é¢˜å¤±è´¥', 'error');
            }
        }

        // ==================== è¾…åŠ©å‡½æ•° ====================
        function resetState() {
            state.answers = {};
            state.startTime = new Date();
            state.timeLeft = 600;
            state.isActive = true;
            state.mode = elements.modeSelect.value;
        }

        function saveTempProgress() {
            if (state.isActive && Object.keys(state.answers).length > 0) {
                const progress = {
                    answers: state.answers,
                    timeLeft: state.timeLeft,
                    problems: state.problems,
                    mode: state.mode,
                    timestamp: Date.now(),
                    isSmartPractice: state.isSmartPractice
                };
                localStorage.setItem('tempProgress', JSON.stringify(progress));
            }
        }

        function showNotification(message, type = 'info') {
            const oldNotification = document.querySelector('.notification');
            if (oldNotification) oldNotification.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: ${type === 'error' ? '#f44336' : type === 'success' ? '#4CAF50' : '#2196F3'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç»ƒä¹ è®°å½•å’Œé”™é¢˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                try {
                    localStorage.removeItem('mathPracticeHistory');
                    localStorage.removeItem('mathWrongProblems');
                    localStorage.removeItem('tempAnswers');
                    localStorage.removeItem('tempProgress');
                    localStorage.removeItem('problemCount');
                    elements.historyContent.innerHTML = '<p style="text-align: center; color: #4CAF50;">æ•°æ®å·²æ¸…é™¤</p>';
                    showNotification('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤', 'success');
                } catch (e) {
                    showNotification('æ¸…é™¤æ•°æ®å¤±è´¥: ' + e.message, 'error');
                }
            }
        }

        // ==================== PWAæ”¯æŒ ====================
        function initPWA() {
            if ('serviceWorker' in navigator) {
                const serviceWorkerCode = `
                    const CACHE_NAME = 'math-corrected-v1';
                    const urlsToCache = ['./', './?utm_source=homescreen'];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('activate', event => {
                        event.waitUntil(
                            caches.keys().then(cacheNames => {
                                return Promise.all(
                                    cacheNames.map(cacheName => {
                                        if (cacheName !== CACHE_NAME) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                `;
                navigator.serviceWorker.register('./service-worker.js')
                    .then(() => console.log('Service Worker æ³¨å†ŒæˆåŠŸ'))
                    .catch(error => console.log('Service Worker æ³¨å†Œå¤±è´¥:', error));
            }
            
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                elements.installBtn.classList.remove('hidden');
            });
            
            elements.installBtn.addEventListener('click', async () => {
                if (!deferredPrompt) return;
                
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    elements.installBtn.classList.add('hidden');
                    showNotification('åº”ç”¨å·²å®‰è£…åˆ°æ¡Œé¢', 'success');
                }
                
                deferredPrompt = null;
            });
            
            window.addEventListener('appinstalled', () => {
                elements.installBtn.classList.add('hidden');
            });
        }

        // ==================== æ¢å¤æœªå®Œæˆçš„ç»ƒä¹  ====================
        window.addEventListener('load', () => {
            try {
                const tempProgress = localStorage.getItem('tempProgress');
                if (tempProgress) {
                    const progress = JSON.parse(tempProgress);
                    const timeSince = Date.now() - progress.timestamp;
                    
                    if (timeSince < 3600000) {
                        if (confirm('æ£€æµ‹åˆ°æœªå®Œæˆçš„ç»ƒä¹ ï¼Œæ˜¯å¦æ¢å¤ï¼Ÿ')) {
                            state.answers = progress.answers;
                            state.timeLeft = progress.timeLeft;
                            state.problems = progress.problems;
                            state.mode = progress.mode;
                            state.totalProblems = progress.problems.length;
                            state.isSmartPractice = progress.isSmartPractice || false;
                            state.isActive = true;
                            
                            elements.problemCountInput.value = state.totalProblems;
                            elements.modeSelect.value = state.mode;
                            
                            // æ›´æ–°è¿ç®—ç¬¦ç»Ÿè®¡
                            updateOperatorStats();
                            
                            elements.problemArea.classList.remove('hidden');
                            elements.statsInfo.classList.remove('hidden');
                            elements.resultArea.classList.add('hidden');
                            
                            if (state.isSmartPractice) {
                                elements.smartPracticeInfo.classList.remove('hidden');
                                elements.smartPracticeInfo.innerHTML = 'ğŸ“š <strong>æ¢å¤æ™ºèƒ½ç»ƒä¹ </strong>';
                            }
                            
                            renderProblems();
                            elements.submitBtn.disabled = false;
                            elements.startBtn.disabled = true;
                            elements.smartPracticeBtn.disabled = true;
                            
                            startTimer();
                            
                            showNotification('å·²æ¢å¤æœªå®Œæˆçš„ç»ƒä¹ ', 'success');
                            return;
                        }
                    }
                }
                
                localStorage.removeItem('tempProgress');
                localStorage.removeItem('tempAnswers');
            } catch (e) {
                console.error('æ¢å¤ç»ƒä¹ å¤±è´¥:', e);
            }
        });

        // ==================== å…¨å±€å‡½æ•°å¯¼å‡º ====================
        window.saveAnswer = saveAnswer;
        window.handleEnterKey = handleEnterKey;
        window.redoWrongProblem = redoWrongProblem;
        window.smartPracticeFromProblem = smartPracticeFromProblem;

        console.log('ä¿®æ­£ç‰ˆå››åˆ™è¿ç®—ç»ƒä¹ å™¨åŠ è½½å®Œæˆï¼');
        console.log('ç‰ˆæœ¬è¯´æ˜ï¼šä¿®å¤äº†ä¹˜é™¤é¢˜ç›®ç”Ÿæˆé—®é¢˜ï¼Œç¡®ä¿å››ç§è¿ç®—éƒ½èƒ½æ­£å¸¸ç”Ÿæˆ');
    </script>
</body>
</html>